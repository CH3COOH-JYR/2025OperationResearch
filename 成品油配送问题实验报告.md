# 基于遗传算法的成品油二次配送车辆路径问题研究实验报告

**实验人员**：[任宣宇]  
**实验时间**：2025年6月  
**问题类型**：多约束车辆路径问题（CVRP）  
**解决方法**：改进遗传算法  

---

## 1. 问题背景与实验目标

### 1.1 问题描述
成品油二次配送是指从油库到加油站的配送过程，具有以下特点：
- 2个油库（A、B）向25个加油站配送3种油品（92号汽油、95号汽油、0号柴油）
- 40辆油罐车，每车有两个等容量储油仓，不能混装
- 考虑时间窗约束（8:00-17:00）、库容约束、需求约束等

### 1.2 核心约束理解
经过深入分析，识别出两个关键约束：
1. **储油仓约束**：每辆车有两个储油仓，每个仓的油只能全部卸给一个站，但一辆车可以运两种油给同一个加油站
2. **路径连通性**：车辆路径不需要直达，可以通过中转站点实现连通

### 1.3 实验目标
- 最小化总运输成本
- 满足所有配送需求（100%覆盖率）
- 遵守所有约束条件
- 生成可执行的详细配送方案

---

## 2. 实验思路与方法论

### 2.1 总体思路演进

#### 阶段1：问题建模与数据预处理
**思路**：将复杂的现实问题转化为数学模型
- 节点映射：油库编号0-1，加油站编号2-26
- 距离矩阵构建：27×27的完整距离矩阵
- 需求分析：考虑库存约束的实际配送需求

#### 阶段2：初版算法设计
**思路**：基于经典遗传算法框架
- 个体编码：车辆ID + 储油仓任务 + 访问路径
- 适应度函数：以运输成本为主要目标
- 遗传操作：交叉、变异、选择

#### 阶段3：问题发现与分析
**发现**：算法运行后出现路径距离无穷大的问题
**分析**：站点间不完全连通，存在无法直达的路径

#### 阶段4：算法改进与优化
**思路**：引入Floyd-Warshall算法解决连通性问题
- 计算所有节点间最短路径
- 支持中转路径规划
- 优化适应度函数

#### 阶段5：方案验证与输出
**思路**：确保解决方案的完整性和可执行性
- 详细配送方案生成
- 覆盖率严格验证
- 多格式结果输出

### 2.2 技术路线图

```
问题理解 → 数据处理 → 初版算法 → 问题发现 → 算法改进 → 方案验证
    ↓           ↓           ↓           ↓           ↓           ↓
约束分析    CSV转换    基础GA    路径问题    Floyd算法   100%覆盖
需求建模    距离矩阵    个体编码    连通性     路径优化    详细输出
```

---

## 3. 实现方法详述

### 3.1 数据预处理模块

```python
def load_data(self):
    """加载并预处理所有数据文件"""
    # Excel到CSV转换
    # 节点映射构建
    # 距离矩阵初始化
```

**创新点**：
- 统一的节点编码系统
- 考虑库存约束的需求分析
- 完整的27×27距离矩阵构建

### 3.2 路径连通性解决方案

```python
def floyd_warshall(self):
    """使用Floyd-Warshall算法计算最短路径"""
    for k in range(n):
        for i in range(n):
            for j in range(n):
                if new_distance < self.shortest_path_matrix[i][j]:
                    self.shortest_path_matrix[i][j] = new_distance
```

**技术突破**：
- 解决了站点间不完全连通问题
- 支持通过油库或其他站点中转
- 大幅降低了路径规划复杂度

### 3.3 个体编码设计

```python
individual = [{
    'vehicle_id': 车辆ID,
    'compartment1': [(站点, 油品, 数量), ...],
    'compartment2': [(站点, 油品, 数量), ...],
    'path': [访问顺序]
}]
```

**设计亮点**：
- 精确建模双储油仓约束
- 灵活的任务分配机制
- 路径与任务分离设计

### 3.4 适应度函数优化

```python
def calculate_fitness(self, individual):
    # 基础成本计算
    total_cost = route_distance * unit_cost
    
    # 多层次惩罚机制
    penalty += time_window_penalty    # 时间窗惩罚
    penalty += utilization_penalty    # 利用率惩罚
    penalty += uncompleted_penalty    # 未完成任务惩罚
    
    return 1 / (total_cost + penalty + 1)
```

**优化策略**：
- 多目标权衡机制
- 渐进式惩罚函数
- 覆盖率强制保证

---

## 4. 关键问题与解决历程

### 4.1 问题1：路径距离无穷大

**问题现象**：
```
算法运行结果：路径距离 = inf km, 成本 = inf 元
```

**问题分析**：
- 站站运距矩阵不完整，存在不可达路径
- 直接使用距离矩阵导致无穷大距离
- 影响适应度计算，算法无法收敛

**解决思路演进**：
1. **初步尝试**：填充缺失距离为大数值 → 效果不佳
2. **关键洞察**：现实中可以通过中转实现连通
3. **最终方案**：Floyd-Warshall算法计算最短路径

**实现效果**：
```python
# 改进前
self.distance_matrix[i][j] = np.inf  # 不可达

# 改进后  
self.shortest_path_matrix[i][j] = 最短中转距离
```

**心路历程**：
这个问题让我意识到，算法建模必须贴近现实约束。真实配送中，司机可以通过多种路径到达目标，这种灵活性应该体现在算法中。Floyd算法的引入不仅解决了技术问题，更重要的是让模型更加符合实际操作场景。

### 4.2 问题2：储油仓约束建模

**问题挑战**：
- 每车两个储油仓，容量相等但独立
- 每个仓的油只能全部卸给一个站
- 一辆车可以给多个站配送不同油品

**解决演进**：

**版本1.0**：简单任务列表
```python
gene = {'vehicle_id': id, 'tasks': [...]}
```
**问题**：无法区分储油仓，违反约束

**版本2.0**：储油仓分离设计
```python
gene = {
    'vehicle_id': id,
    'compartment1': [...],  # 储油仓1任务
    'compartment2': [...],  # 储油仓2任务
    'path': [...]
}
```
**优势**：精确建模，满足约束

**心路历程**：
储油仓约束是这个问题的核心难点。最初我试图简化这个约束，但实验过程中发现简化会导致解决方案不可行。深入理解约束本质后，我重新设计了个体编码，虽然增加了复杂度，但保证了方案的实际可执行性。

### 4.3 问题3：覆盖率验证

**验证挑战**：
- 如何确保100%覆盖率？
- 75个任务 vs 25个加油站的区别
- 算法声称100%覆盖是否可信？

**验证方法设计**：
```python
# 严格的任务级验证
required_tasks = set()
for station_id, oils in delivery_requirements.items():
    for oil_code in oils:
        required_tasks.add((station_id, oil_code))

completed_tasks = set()
for gene in solution:
    for task in gene['compartment1'] + gene['compartment2']:
        completed_tasks.add((task[0], task[1]))

coverage_rate = len(completed_tasks) / len(required_tasks) * 100
```

**验证结果**：
```
总任务数: 75
完成任务数: 75  
覆盖率: 100.0% ✓
```

## 5. 最终实验结果

### 5.1 算法性能指标

| 指标 | 数值 | 说明 |
|------|------|------|
| 收敛代数 | 20代 | 快速收敛 |
| 最优适应度 | 0.000054 | 稳定收敛 |
| 运行时间 | <2分钟 | 高效求解 |
| 解决方案质量 | 100%覆盖 | 完全满足需求 |

### 5.2 方案质量评估

| 评估维度 | 结果 | 评价 |
|----------|------|------|
| 成本效率 | 0.0298元/L | 优秀 |
| 车辆利用 | 32辆/40辆 | 良好 |
| 路径优化 | 支持中转 | 创新 |
| 约束满足 | 100%合规 | 完美 |

### 5.3 技术创新点总结

1. **中转路径支持**
   - Floyd-Warshall算法应用
   - 解决图不完全连通问题
   - 提供灵活的路径选择

2. **精确约束建模**
   - 双储油仓独立建模
   - 任务与路径分离设计
   - 确保方案可执行性

3. **多层次验证机制**
   - 算法内置覆盖率监控
   - 独立验证程序
   - 详细输出文件生成

---

## 6. 实验总结与反思

### 6.1 成功经验总结

1. **深入理解问题本质**
   - 不急于编码，先理解约束
   - 与现实场景对照验证
   - 约束建模决定方案质量

2. **迭代改进策略**
   - 从简单模型开始
   - 逐步添加复杂约束
   - 每次改进都要验证效果

3. **系统化思维**
   - 算法只是工具，解决问题是目标
   - 重视输入输出接口设计
   - 建立完整的验证体系

### 6.2 技术挑战与突破

**最大挑战**：路径连通性问题
**解决突破**：Floyd-Warshall算法的创新应用

**次要挑战**：储油仓约束建模
**解决方案**：个体编码结构重新设计

**验证挑战**：覆盖率真实性验证
**解决方法**：独立验证程序开发

---

## 7. 附录

### 7.1 核心代码文件
- `genetic_algorithm_improved.py` - 改进版遗传算法
- `detailed_delivery_solution.py` - 带详细输出的算法版本
- `coverage_verification.py` - 覆盖率验证程序

### 7.2 输出文件
- `详细配送运输方案.xlsx` - 完整配送方案
- `成品油配送问题解决方案报告.md` - 技术报告
- `最终配送方案验证报告.md` - 验证报告

### 7.3 实验数据
- 总配送量：623,874升
- 使用车辆：32辆
- 总成本：18,602.64元
- 覆盖率：100%

---

*实验报告完成时间：2025年6月*  
*实验状态：成功完成，100%覆盖率验证通过* ✅ 